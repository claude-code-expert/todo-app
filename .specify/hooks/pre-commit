#!/bin/bash
# Pre-commit hook: CHANGELOG.md ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏
# ÏÑ§Ïπò: bash .specify/scripts/bash/install-hooks.sh

set -e

CHANGELOG="CHANGELOG.md"

# 1. CHANGELOG.mdÍ∞Ä Ïù¥ÎØ∏ stagedÏóê ÏûàÏúºÎ©¥ Ïä§ÌÇµ (/changelog Ïä§ÌÇ¨Î°ú ÏàòÎèô Ïã§ÌñâÌïú Í≤ΩÏö∞)
if git diff --cached --name-only | grep -q "^${CHANGELOG}$"; then
    exit 0
fi

# 2. staged ÌååÏùºÏù¥ ÏóÜÏúºÎ©¥ Ïä§ÌÇµ
STAGED_FILES=$(git diff --cached --name-only)
if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# 3. Î∏åÎûúÏπòÎ™Ö, ÎÇ†Ïßú/ÏãúÍ∞Ñ
BRANCH=$(git branch --show-current 2>/dev/null || echo "detached")
DATETIME=$(date '+%Y-%m-%d %H:%M')

# 4. staged ÌååÏùº Î≥ÄÍ≤Ω ÎÇ¥Ïó≠ ÏàòÏßë
CHANGES=""
while IFS=$'\t' read -r status file; do
    case "$status" in
        A) CHANGES="${CHANGES}\n- **Added**: \`${file}\`" ;;
        M) CHANGES="${CHANGES}\n- **Modified**: \`${file}\`" ;;
        D) CHANGES="${CHANGES}\n- **Deleted**: \`${file}\`" ;;
        R*) CHANGES="${CHANGES}\n- **Renamed**: \`${file}\`" ;;
        *)  CHANGES="${CHANGES}\n- **Changed**: \`${file}\`" ;;
    esac
done < <(git diff --cached --name-status)

# 5. ÌååÏùºÎ≥Ñ ÎùºÏù∏ Ïàò ÏàòÏßë
FILES_STAT=""
while IFS= read -r line; do
    # "  10  5  src/file.ts" ÌòïÏãù ÌååÏã±
    insertions=$(echo "$line" | awk '{print $1}')
    deletions=$(echo "$line" | awk '{print $2}')
    filepath=$(echo "$line" | awk '{print $3}')
    if [ -n "$filepath" ]; then
        FILES_STAT="${FILES_STAT}\n- \`${filepath}\` (+${insertions}, -${deletions} lines)"
    fi
done < <(git diff --cached --numstat)

# 6. CHANGELOG.mdÍ∞Ä ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
if [ ! -f "$CHANGELOG" ]; then
    cat > "$CHANGELOG" << 'HEADER'
# Tika Development Changelog

> Ïù¥ Î¨∏ÏÑúÎäî Tika ÌîÑÎ°úÏ†ùÌä∏Ïùò Í∞úÎ∞ú ÌûàÏä§ÌÜ†Î¶¨Î•º Í∏∞Î°ùÌï©ÎãàÎã§.
> Í∞Å ÏóîÌä∏Î¶¨Îäî ÌîÑÎ°¨ÌîÑÌä∏, Î≥ÄÍ≤ΩÏÇ¨Ìï≠, ÏòÅÌñ•Î∞õÏùÄ ÌååÏùºÏùÑ Ìè¨Ìï®Ìï©ÎãàÎã§.

---

HEADER
fi

# 7. ÏóîÌä∏Î¶¨Î•º ÏûÑÏãú ÌååÏùºÏóê ÏÉùÏÑ±
ENTRY_FILE=$(mktemp)
{
    echo "## [${BRANCH}] - ${DATETIME}"
    echo ""
    echo "### üéØ Prompt"
    echo "> See commit message"
    echo ""
    echo "### ‚úÖ Changes"
    echo -e "$CHANGES"
    echo ""
    echo "### üìÅ Files Modified"
    echo -e "$FILES_STAT"
    echo ""
    echo "---"
} > "$ENTRY_FILE"

# 8. CHANGELOG.md ÏµúÏÉÅÎã®(--- Íµ¨Î∂ÑÏÑ† Îã§Ïùå)Ïóê ÏóîÌä∏Î¶¨ ÏÇΩÏûÖ
TEMP_FILE=$(mktemp)
INSERTED=false
while IFS= read -r line; do
    echo "$line" >> "$TEMP_FILE"
    if [ "$line" = "---" ] && [ "$INSERTED" = false ]; then
        echo "" >> "$TEMP_FILE"
        cat "$ENTRY_FILE" >> "$TEMP_FILE"
        echo "" >> "$TEMP_FILE"
        INSERTED=true
    fi
done < "$CHANGELOG"
mv "$TEMP_FILE" "$CHANGELOG"
rm -f "$ENTRY_FILE"

# 9. CHANGELOG.mdÎ•º stagingÏóê Ï∂îÍ∞Ä
git add "$CHANGELOG"

echo "üìù CHANGELOG.md ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å [${BRANCH}] ${DATETIME}"
